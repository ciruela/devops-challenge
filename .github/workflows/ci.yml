name: CI - build, scan, and smoke tests

on:
  push:
    branches: [ main, 'feature/*' ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-smoke:
    runs-on: ubuntu-latest
    env:
      KIND_CLUSTER: ci
      ARTIFACT_BLUE: k6-bluegreen.json
      ARTIFACT_CANARY: k6-canary.json
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install utilities
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl unzip

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Set up Kind
        uses: engineerd/setup-kind@v0.5.0
        with:
          version: v0.20.0

      - name: Create kind cluster
        run: |
          kind create cluster --name $KIND_CLUSTER || true

      - name: Set kubectl context
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Verify kubectl
        run: kubectl version --client || kubectl version || true

      - name: Build service images
        run: |
          docker build -t content-blue:local -f apps/blue-v1/Dockerfile .
          docker build -t content-green:local -f apps/blue-v2/Dockerfile .
          docker build -t content-canary:local -f apps/canary/Dockerfile . || true
          # build a hermetic k6 image for CI (avoid public multi-arch pulls)
          docker build -t local/k6:ci -f scripts/k6/Dockerfile .

      - name: Load images into kind
        run: |
          kind load docker-image content-blue:local --name $KIND_CLUSTER
          kind load docker-image content-green:local --name $KIND_CLUSTER
          kind load docker-image content-canary:local --name $KIND_CLUSTER || true
          kind load docker-image local/k6:ci --name $KIND_CLUSTER

      - name: Scan built images with Trivy (generate reports)
        run: |
          mkdir -p artifacts/trivy
          echo "Scanning content-blue:local"
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v $PWD/artifacts/trivy:/reports aquasec/trivy:0.44.0 image --format json --output /reports/trivy-content-blue.json --severity HIGH,CRITICAL content-blue:local || true
          echo "Scanning content-green:local"
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v $PWD/artifacts/trivy:/reports aquasec/trivy:0.44.0 image --format json --output /reports/trivy-content-green.json --severity HIGH,CRITICAL content-green:local || true
          echo "Scanning content-canary:local"
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v $PWD/artifacts/trivy:/reports aquasec/trivy:0.44.0 image --format json --output /reports/trivy-content-canary.json --severity HIGH,CRITICAL content-canary:local || true
          echo "Scanning local/k6:ci"
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v $PWD/artifacts/trivy:/reports aquasec/trivy:0.44.0 image --format json --output /reports/trivy-local-k6.json --severity HIGH,CRITICAL local/k6:ci || true

      - name: Upload Trivy reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports
          path: artifacts/trivy

      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f k8s/blue-green
          kubectl apply -f k8s/canary || true
          kubectl apply -f k8s/load-test/configmap-k6.yaml || true

      - name: Wait for pods ready
        run: kubectl wait --for=condition=ready pod -l app=content --timeout=120s || true

      - name: Extract k6 scripts from ConfigMap
        run: |
          mkdir -p artifacts
          kubectl get configmap k6-scripts -o json | jq -r '.data["blue-green.js"]' > artifacts/blue-green.js
          kubectl get configmap k6-scripts -o json | jq -r '.data["canary.js"]' > artifacts/canary.js

      - name: Download k6 binary
        run: |
          # Download k6 and make it executable for the runner
          K6_VERSION=v0.46.0
          curl -sSL https://github.com/grafana/k6/releases/download/${K6_VERSION}/k6-${K6_VERSION}-linux-amd64.tar.gz -o /tmp/k6.tar.gz
          tar -xzf /tmp/k6.tar.gz -C /tmp
          sudo mv /tmp/k6-${K6_VERSION}-linux-amd64/k6 /usr/local/bin/k6
          k6 version

      - name: Run k6 blue-green (runner-local)
        run: |
          # Port-forward service and run k6 locally on the runner to avoid kubectl cp fragility
          kubectl port-forward svc/content-service 8080:80 >/dev/null 2>&1 &
          PF=$!
          sleep 2
          /usr/local/bin/k6 run --out json=./${ARTIFACT_BLUE} ./artifacts/blue-green.js || true
          kill $PF || true

      - name: Upload k6-bluegreen artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-bluegreen-results
          path: ${{ env.ARTIFACT_BLUE }}

      - name: Run k6 canary (runner-local)
        run: |
          kubectl port-forward svc/content-service-canary 8081:80 >/dev/null 2>&1 &
          PF=$!
          sleep 2
          /usr/local/bin/k6 run --out json=./${ARTIFACT_CANARY} ./artifacts/canary.js || true
          kill $PF || true

      - name: Upload k6-canary artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-canary-results
          path: ${{ env.ARTIFACT_CANARY }}

      - name: Tear down kind
        if: always()
        run: kind delete cluster --name $KIND_CLUSTER || true
